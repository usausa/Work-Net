using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using WorkCliHost;

// 最小構成版のテスト
var builder = CliHost.CreateBuilder(args);

// 必要な機能だけを追加
if (args.Contains("--use-config"))
{
    builder.UseDefaultConfiguration();
}

if (args.Contains("--debug"))
{
    builder.AddDebugLogging();
    builder.SetMinimumLogLevel(LogLevel.Debug);
}

// サービスの追加
builder.Services.AddSingleton<IMyCustomService, MyCustomService>();

// コマンド設定
builder.ConfigureCommands(commands =>
{
    commands.ConfigureRootCommand(root =>
    {
        root.WithDescription("CLI Host Framework - Minimal Configuration Example");
    });
    
    // グローバルフィルタ
    commands.AddGlobalFilter<TimingFilter>(order: -100);
    
    // コマンド
    commands.AddCommand<MessageCommand>();
    commands.AddCommand<GreetCommand>();
    commands.AddCommand<UserCommand>(user =>
    {
        user.AddSubCommand<UserListCommand>();
        user.AddSubCommand<UserAddCommand>();
        user.AddSubCommand<UserRoleCommand>(role =>
        {
            role.AddSubCommand<UserRoleAssignCommand>();
            role.AddSubCommand<UserRoleRemoveCommand>();
            role.AddSubCommand<UserRoleVerifyCommand>();
        });
        user.AddSubCommand<UserPermissionGrantCommand>();
    });
    
    commands.AddCommand<ConfigCommand>(config =>
    {
        config.AddSubCommand<ConfigSetCommand>();
        config.AddSubCommand<ConfigGetCommand>();
    });
    
    commands.AddCommand<DeployCommand>();
    commands.AddCommand<TestFilterCommand>();
    commands.AddCommand<TestExceptionCommand>();
});

var host = builder.Build();
return await host.RunAsync();

// ダミーサービス
public interface IMyCustomService { }
public class MyCustomService : IMyCustomService { }
