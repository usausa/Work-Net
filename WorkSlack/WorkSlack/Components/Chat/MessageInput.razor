@inject IJSRuntime JS

<div class="message-input-container">
    <div class="message-input-wrapper">
        <div class="input-toolbar">
            <button class="toolbar-btn" title="Bold (*text*)" @onclick='() => InsertFormatAsync("*", "*")'>ùêÅ</button>
            <button class="toolbar-btn" title="Italic (_text_)" @onclick='() => InsertFormatAsync("_", "_")'>ùêº</button>
            <button class="toolbar-btn" title="Strikethrough (~text~)" @onclick='() => InsertFormatAsync("~", "~")'>SÃ∂</button>
            <span class="toolbar-divider"></span>
            <button class="toolbar-btn" title="Code" @onclick='() => InsertFormatAsync("`", "`")'>&lt;/&gt;</button>
            <button class="toolbar-btn" title="Quote (> text)" @onclick='() => InsertFormatAsync("> ", "")'>‚ùù</button>
        </div>
        <div class="input-area">
            <textarea @ref="_inputRef"
                      @bind="MessageText"
                      @bind:event="oninput"
                      @onkeydown="HandleKeyDownAsync"
                      placeholder="@Placeholder"
                      rows="1"></textarea>
        </div>
        <div class="input-footer">
            <div class="input-actions-left">
                <button class="footer-btn" title="Attach file" @onclick="ToggleAttachDialog">üìé</button>
                <div class="footer-btn-wrapper">
                    <button class="footer-btn" title="Emoji" @onclick="ToggleEmojiPicker" @onclick:stopPropagation="true">üòä</button>
                    @if (_showEmojiPicker)
                    {
                        <div class="emoji-picker-anchor">
                            <EmojiPicker OnSelect="InsertEmojiAsync" OnClose="CloseEmojiPicker" />
                        </div>
                    }
                </div>
                <button class="footer-btn" title="Mention" @onclick="InsertMentionAsync">Ôº†</button>
            </div>
            <div class="input-actions-right">
                <button class="send-btn @(string.IsNullOrWhiteSpace(MessageText) ? "send-btn-disabled" : "")"
                        @onclick="SendAsync"
                        disabled="@string.IsNullOrWhiteSpace(MessageText)"
                        title="Send message">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M1.5 1.5L14.5 8L1.5 14.5V9.5L10.5 8L1.5 6.5V1.5Z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    @if (_showAttachDialog)
    {
        <div class="mini-dialog-backdrop" @onclick="() => _showAttachDialog = false"></div>
        <div class="mini-dialog">
            <div class="mini-dialog-header">
                <span>Upload a file</span>
                <button class="mini-dialog-close" @onclick="() => _showAttachDialog = false">‚úï</button>
            </div>
            <div class="mini-dialog-body">
                <div class="attach-dropzone">
                    <span class="attach-dropzone-icon">üìÅ</span>
                    <p>Drag and drop a file here, or click to browse</p>
                    <button class="attach-browse-btn">Browse files</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string Placeholder { get; set; } = "Message";

    [Parameter]
    public EventCallback<string> OnSend { get; set; }

    private string MessageText { get; set; } = "";
    private ElementReference _inputRef;
    private bool _showEmojiPicker;
    private bool _showAttachDialog;

    private async Task HandleKeyDownAsync(KeyboardEventArgs e)
    {
        if (e is { Key: "Enter", ShiftKey: false })
        {
            await SendAsync();
        }
    }

    private async Task SendAsync()
    {
        if (string.IsNullOrWhiteSpace(MessageText))
        {
            return;
        }

        var text = MessageText.Trim();
        MessageText = "";
        _showEmojiPicker = false;
        await OnSend.InvokeAsync(text);
        await PlaySendSoundAsync();
    }

    private async Task PlaySendSoundAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("eval",
                "(function(){try{var a=new AudioContext(),o=a.createOscillator(),g=a.createGain();" +
                "o.type='sine';o.frequency.setValueAtTime(400,a.currentTime);" +
                "o.frequency.exponentialRampToValueAtTime(800,a.currentTime+0.08);" +
                "g.gain.setValueAtTime(0.12,a.currentTime);" +
                "g.gain.exponentialRampToValueAtTime(0.001,a.currentTime+0.1);" +
                "o.connect(g);g.connect(a.destination);o.start();o.stop(a.currentTime+0.1)}catch(e){}})()");
        }
        catch (JSDisconnectedException)
        {
            // Ignored during prerender or disconnect
        }
    }

    private void ToggleEmojiPicker()
    {
        _showEmojiPicker = !_showEmojiPicker;
        _showAttachDialog = false;
    }

    private void CloseEmojiPicker()
    {
        _showEmojiPicker = false;
    }

    private Task InsertEmojiAsync(string emoji)
    {
        MessageText += emoji;
        _showEmojiPicker = false;
        return Task.CompletedTask;
    }

    private void ToggleAttachDialog()
    {
        _showAttachDialog = !_showAttachDialog;
        _showEmojiPicker = false;
    }

    private Task InsertFormatAsync(string prefix, string suffix)
    {
        MessageText += prefix + "text" + suffix;
        return Task.CompletedTask;
    }

    private Task InsertMentionAsync()
    {
        MessageText += "@";
        return Task.CompletedTask;
    }
}
