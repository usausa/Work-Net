@using WorkSlack.Models
@using WorkSlack.Services
@inject IChatService ChatService

<nav class="sidebar">
    <div class="sidebar-header">
        <div class="workspace-info">
            <h1 class="workspace-name">WorkSlack</h1>
            <button class="workspace-status-btn" @onclick="() => _showStatusDialog = true">
                <span class="status-dot"></span>
                @if (_currentUser.CustomStatusEmoji is not null)
                {
                    <span>@_currentUser.CustomStatusEmoji</span>
                }
                <span>@_currentUser.DisplayName</span>
            </button>
        </div>
        <button class="compose-btn" title="New message" @onclick="() => _showComposeDialog = true">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M14.7 1.3a1 1 0 00-1.4 0L6 8.6V10h1.4l7.3-7.3a1 1 0 000-1.4zM5 11V10l-1-1H2v4h4v-2H5z" />
            </svg>
        </button>
    </div>

    <div class="sidebar-search">
        <div class="sidebar-search-box">
            <span class="sidebar-search-icon">üîç</span>
            <input type="text" placeholder="Search WorkSlack" @bind="_filterText" @bind:event="oninput" />
        </div>
    </div>

    <div class="sidebar-content">
        <div class="nav-section">
            <button class="nav-item" @onclick="() => _showThreadsDialog = true">
                <span class="nav-icon">üí¨</span>
                <span>Threads</span>
            </button>
            <button class="nav-item" @onclick="() => _showDraftsDialog = true">
                <span class="nav-icon">üì®</span>
                <span>Drafts & Sent</span>
            </button>
            <button class="nav-item" @onclick="() => _showSavedDialog = true">
                <span class="nav-icon">üîñ</span>
                <span>Saved items</span>
            </button>
        </div>

        <div class="nav-section">
            <button class="section-header" @onclick="() => _channelsExpanded = !_channelsExpanded">
                <span class="section-caret @(_channelsExpanded ? "caret-down" : "")">‚ñ∂</span>
                <span class="section-title">Channels</span>
            </button>
            @if (_channelsExpanded)
            {
                @foreach (var channel in FilteredChannels)
                {
                    var unread = ChatService.GetUnreadCount(channel.Id);
                    <button class="nav-item channel-item @(channel.Id == SelectedChannelId ? "nav-item-active" : "") @(unread > 0 ? "nav-item-unread" : "")"
                            @onclick="() => SelectChannel(channel.Id)">
                        <span class="channel-prefix">#</span>
                        <span class="channel-name">@channel.Name</span>
                        @if (unread > 0)
                        {
                            <span class="unread-badge">@unread</span>
                        }
                    </button>
                }
                <button class="nav-item add-item" @onclick="() => _showAddChannelDialog = true">
                    <span class="nav-icon">+</span>
                    <span>Add channels</span>
                </button>
            }
        </div>

        <div class="nav-section">
            <button class="section-header" @onclick="() => _dmsExpanded = !_dmsExpanded">
                <span class="section-caret @(_dmsExpanded ? "caret-down" : "")">‚ñ∂</span>
                <span class="section-title">Direct messages</span>
            </button>
            @if (_dmsExpanded)
            {
                @foreach (var dm in FilteredDirectMessages)
                {
                    var dmUser = ChatService.GetUser(dm.DmUserId ?? "");
                    var unread = ChatService.GetUnreadCount(dm.Id);
                    <button class="nav-item dm-item @(dm.Id == SelectedChannelId ? "nav-item-active" : "") @(unread > 0 ? "nav-item-unread" : "")"
                            @onclick="() => SelectChannel(dm.Id)">
                        @if (dmUser is not null)
                        {
                            <UserAvatar User="@dmUser" Size="UserAvatar.AvatarSize.Small" ShowStatus="true" />
                        }
                        <span class="channel-name">@dm.Name</span>
                        @if (unread > 0)
                        {
                            <span class="unread-badge">@unread</span>
                        }
                    </button>
                }
                <button class="nav-item add-item" @onclick="() => _showAddDmDialog = true">
                    <span class="nav-icon">+</span>
                    <span>Add teammates</span>
                </button>
            }
        </div>
    </div>
</nav>

@* Stub dialogs *@
@if (_showComposeDialog)
{
    <div class="modal-backdrop" @onclick="CloseAllDialogs"></div>
    <div class="modal-dialog">
        <div class="modal-dialog-header">
            <span>New message</span>
            <button class="modal-dialog-close" @onclick="CloseAllDialogs">‚úï</button>
        </div>
        <div class="modal-dialog-body">
            <label>To:</label>
            <input type="text" placeholder="Search for a person or channel" class="modal-input" />
            <label>Message:</label>
            <textarea placeholder="Write a message..." rows="3" class="modal-textarea"></textarea>
        </div>
        <div class="modal-dialog-footer">
            <button class="modal-primary-btn" @onclick="CloseAllDialogs">Send</button>
        </div>
    </div>
}

@if (_showAddChannelDialog)
{
    <div class="modal-backdrop" @onclick="CloseAllDialogs"></div>
    <div class="modal-dialog">
        <div class="modal-dialog-header">
            <span>Create a channel</span>
            <button class="modal-dialog-close" @onclick="CloseAllDialogs">‚úï</button>
        </div>
        <div class="modal-dialog-body">
            <label>Name</label>
            <input type="text" placeholder="e.g. plan-budget" class="modal-input" />
            <label>Description <span class="modal-optional">(optional)</span></label>
            <input type="text" placeholder="What's this channel about?" class="modal-input" />
        </div>
        <div class="modal-dialog-footer">
            <button class="modal-primary-btn" @onclick="CloseAllDialogs">Create</button>
        </div>
    </div>
}

@if (_showAddDmDialog)
{
    <div class="modal-backdrop" @onclick="CloseAllDialogs"></div>
    <div class="modal-dialog">
        <div class="modal-dialog-header">
            <span>Direct messages</span>
            <button class="modal-dialog-close" @onclick="CloseAllDialogs">‚úï</button>
        </div>
        <div class="modal-dialog-body">
            <input type="text" placeholder="Search for people" class="modal-input" />
            <div class="modal-user-list">
                @foreach (var user in ChatService.GetAllUsers().Where(u => u.Id != _currentUser.Id))
                {
                    <div class="modal-user-row">
                        <UserAvatar User="@user" Size="UserAvatar.AvatarSize.Small" ShowStatus="true" />
                        <span>@user.DisplayName</span>
                    </div>
                }
            </div>
        </div>
    </div>
}

@if (_showThreadsDialog)
{
    <div class="modal-backdrop" @onclick="CloseAllDialogs"></div>
    <div class="modal-dialog">
        <div class="modal-dialog-header">
            <span>Threads</span>
            <button class="modal-dialog-close" @onclick="CloseAllDialogs">‚úï</button>
        </div>
        <div class="modal-dialog-body modal-dialog-body-empty">
            <span class="modal-empty-icon">üí¨</span>
            <p>Threads you follow will appear here.</p>
        </div>
    </div>
}

@if (_showDraftsDialog)
{
    <div class="modal-backdrop" @onclick="CloseAllDialogs"></div>
    <div class="modal-dialog">
        <div class="modal-dialog-header">
            <span>Drafts & Sent</span>
            <button class="modal-dialog-close" @onclick="CloseAllDialogs">‚úï</button>
        </div>
        <div class="modal-dialog-body modal-dialog-body-empty">
            <span class="modal-empty-icon">üì®</span>
            <p>Your drafts and sent messages will appear here.</p>
        </div>
    </div>
}

@if (_showSavedDialog)
{
    <div class="modal-backdrop" @onclick="CloseAllDialogs"></div>
    <div class="modal-dialog">
        <div class="modal-dialog-header">
            <span>Saved items</span>
            <button class="modal-dialog-close" @onclick="CloseAllDialogs">‚úï</button>
        </div>
        <div class="modal-dialog-body">
            @{
                var bookmarks = ChatService.GetBookmarkedMessages();
            }
            @if (bookmarks.Count == 0)
            {
                <div class="modal-dialog-body-empty">
                    <span class="modal-empty-icon">üîñ</span>
                    <p>Your saved messages will appear here.</p>
                    <p class="modal-hint-text">Click üîñ on any message to save it.</p>
                </div>
            }
            else
            {
                @foreach (var msg in bookmarks)
                {
                    var author = ChatService.GetUser(msg.AuthorId);
                    var ch = ChatService.GetChannel(msg.ChannelId);
                    <div class="saved-item">
                        <div class="saved-item-header">
                            @if (author is not null)
                            {
                                <UserAvatar User="@author" Size="UserAvatar.AvatarSize.Small" />
                                <strong>@author.DisplayName</strong>
                            }
                            <span class="saved-item-channel">in #@(ch?.Name ?? "")</span>
                        </div>
                        <div class="saved-item-content">@msg.Content</div>
                    </div>
                }
            }
        </div>
    </div>
}

@if (_showStatusDialog)
{
    <div class="modal-backdrop" @onclick="CloseAllDialogs"></div>
    <div class="modal-dialog">
        <div class="modal-dialog-header">
            <span>Set a status</span>
            <button class="modal-dialog-close" @onclick="CloseAllDialogs">‚úï</button>
        </div>
        <div class="modal-dialog-body">
            <div class="status-preset-list">
                <button class="status-preset" @onclick='() => ApplyStatus("üìÖ", "In a meeting")'>üìÖ In a meeting</button>
                <button class="status-preset" @onclick='() => ApplyStatus("üöå", "Commuting")'>üöå Commuting</button>
                <button class="status-preset" @onclick='() => ApplyStatus("ü§í", "Out sick")'>ü§í Out sick</button>
                <button class="status-preset" @onclick='() => ApplyStatus("üå¥", "Vacationing")'>üå¥ Vacationing</button>
                <button class="status-preset" @onclick='() => ApplyStatus("üè†", "Working remotely")'>üè† Working remotely</button>
                <button class="status-preset" @onclick='() => ApplyStatus("üíª", "Coding")'>üíª Coding</button>
                <button class="status-preset" @onclick='() => ApplyStatus("‚òï", "On break")'>‚òï On break</button>
                <button class="status-preset" @onclick='() => ApplyStatus("üéß", "Focus time")'>üéß Focus time</button>
            </div>
            <div class="status-custom-row">
                <input type="text" class="modal-input" placeholder="What's your status?" @bind="_statusText" />
            </div>
        </div>
        <div class="modal-dialog-footer">
            <button class="edit-cancel-btn" @onclick="ClearStatus">Clear status</button>
            <button class="modal-primary-btn" @onclick="CloseAllDialogs">Save</button>
        </div>
    </div>
}

@code {
    [Parameter]
    public string? SelectedChannelId { get; set; }

    [Parameter]
    public EventCallback<string> OnChannelSelected { get; set; }

    private IReadOnlyList<Channel> _channels = [];
    private IReadOnlyList<Channel> _directMessages = [];
    private ChatUser _currentUser = default!;
    private bool _channelsExpanded = true;
    private bool _dmsExpanded = true;
    private string _filterText = "";

    private bool _showComposeDialog;
    private bool _showAddChannelDialog;
    private bool _showAddDmDialog;
    private bool _showThreadsDialog;
    private bool _showDraftsDialog;
    private bool _showSavedDialog;
    private bool _showStatusDialog;
    private string _statusText = "";

    private IEnumerable<Channel> FilteredChannels =>
        string.IsNullOrWhiteSpace(_filterText)
            ? _channels
            : _channels.Where(c => c.Name.Contains(_filterText, StringComparison.OrdinalIgnoreCase));

    private IEnumerable<Channel> FilteredDirectMessages =>
        string.IsNullOrWhiteSpace(_filterText)
            ? _directMessages
            : _directMessages.Where(c => c.Name.Contains(_filterText, StringComparison.OrdinalIgnoreCase));

    protected override void OnInitialized()
    {
        _channels = ChatService.GetChannels();
        _directMessages = ChatService.GetDirectMessages();
        _currentUser = ChatService.GetCurrentUser();
    }

    private async Task SelectChannel(string channelId)
    {
        await OnChannelSelected.InvokeAsync(channelId);
    }

    private void CloseAllDialogs()
    {
        _showComposeDialog = false;
        _showAddChannelDialog = false;
        _showAddDmDialog = false;
        _showThreadsDialog = false;
        _showDraftsDialog = false;
        _showSavedDialog = false;
        _showStatusDialog = false;
    }

    private void ApplyStatus(string emoji, string text)
    {
        _statusText = text;
        ChatService.SetCustomStatus(emoji, text);
        _currentUser = ChatService.GetCurrentUser();
        _showStatusDialog = false;
    }

    private void ClearStatus()
    {
        _statusText = "";
        ChatService.SetCustomStatus(null, null);
        _currentUser = ChatService.GetCurrentUser();
        _showStatusDialog = false;
    }
}
